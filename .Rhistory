}
#Now randomly assign the donors to the new class:
donors <- percReq[percReq$Donors>0, ]
for (o in unique(donors$PASS)){
amount <- donors[donors$PASS==o, ]$Donors
#Assign the donors to new values
# mzmv[mzmv$Sex==this$Sex & mzmv$ALTER7==this$ALTER7 & mzmv$BMI5 == this$BMI5 & mzmv$PASS == o,][sample(nrow(mzmv[mzmv$Sex==this$Sex & mzmv$ALTER7==this$ALTER7 & mzmv$BMI5 == this$BMI5 & mzmv$PASS == o,]),amount), ]$PASS <- j
selection <-  mzmv[mzmv$Sex==this$Sex & mzmv$ALTER7==this$ALTER7 & mzmv$BMI5 == this$BMI5 & mzmv$PASS == o,]
selection <- selection[sample(1:nrow(selection),amount), ]
selection$PASS <- j
mzmv <- mzmv[!(mzmv$HHNR %in% selection$HHNR), ]
mzmv <- as.data.table(mzmv)
selection <- as.data.table(selection)
bind <- list(mzmv, selection)
mzmv <- rbindlist(bind)
mzmv <- as.data.frame(mzmv)
#Recalculate matrices
percReq <- grouped[grouped$ALTER7==this$ALTER7 & grouped$Sex==this$Sex & grouped$BMI5 == this$BMI5, ]
#Check PASS distribution in mzmv
mz <- mzmv[mzmv$Sex==this$Sex & mzmv$ALTER7==this$ALTER7 & mzmv$BMI5 == this$BMI5,]
MZgrouped <- mz %>% group_by(ALTER7, Sex, BMI5, PASS) %>% dplyr::summarise(n=n())
MZgrouped$percMZ <- MZgrouped$n/sum(MZgrouped$n)
percReq$ALTER7 <- as.numeric(percReq$ALTER7)
MZgrouped$ALTER7 <- as.numeric(MZgrouped$ALTER7)
percReq$PASS <- as.numeric(as.character(percReq$PASS))
MZgrouped$PASS <- as.numeric(as.character(MZgrouped$PASS))
percReq <- left_join(percReq, MZgrouped, by=c("ALTER7", "Sex", "BMI5", "PASS"))
percReq[is.na(percReq)] <- 0
percReq$Perc <- percReq$n.x/sum(percReq$n.x)
percReq$diff <- percReq$percMZ-percReq$Perc
}
#Now the same for the case of a positive difference (here we look from the bottom up)
}
}
}
}
}
rm(list = ls())
library(dplyr)
library(openxlsx)
wege <- read.csv(unz("C:/Users/LMF/polybox/MZMV/MZMV2015_mit_Geo/4_DB_csv/CH_CSV.zip", "wege.csv"))
hh <- read.csv(unz("C:/Users/LMF/polybox/MZMV/MZMV2015_mit_Geo/4_DB_csv/CH_CSV.zip", "haushalte.csv"))
zielpersonen <- read.csv(unz("C:/Users/LMF/polybox/MZMV/MZMV2015_mit_Geo/4_DB_csv/CH_CSV.zip", "zielpersonen.csv"))
zielpersonen$Velo_Verf <- ifelse(zielpersonen$f42100a<0,NA,zielpersonen$f42100a)
#----
#----
#ADD_BZW TRANSFORM VARIABLES TO MATCH THE VARIABLE NAMES IN THE BAG SURVEY
#----
#Add BMI
zielpersonen$BMI <- zielpersonen$f81502/((zielpersonen$f81501/100)^2)
zielpersonen$BMI <- ifelse(zielpersonen$BMI<0,NA, zielpersonen$BMI)
#----
#Add same SettlStructure as in BFS survey
gemeinden <- read.xlsx("C:\\Users\\LMF\\polybox\\BetwAcc_EBikeCity\\Gemeindetypologie 2012\\20593_131.xlsx")
#Daten in Wege so umwandeln, dass das Modell für Vorhersage verwendet werden kann:
colnames(gemeinden) <- c("BFS_NR", "Name","SettlStruc")
hh$SettlStruc <- gemeinden$SettlStruc[match(unlist(hh$W_BFS), gemeinden$BFS_NR)]
test <- hh[is.na(hh$SettlStruc), ]
#Ensure names are the same:
original <- unique(hh$SettlStruc)
original <- original[!is.na(original)]
new <- c("  22.Periurbane Gemeinde mittlerer Dichte",
"  12.Städtische Gemeinde einer mittelgrossen Agglomeration",
"  23.Periurbane Gemeinde geringer Dichte",
"  11.Städtische Gemeinde einer grossen Agglomeration",
"  13.Städtische Gemeinde einer kleinen oder ausserhalb einer Agglomeration",
"  32.Ländliche zentral gelegene Gemeinde",
"  21.Periurbane Gemeinde hoher Dichte",
"  31.Ländliche Zentrumsgemeinde",
"  33.Ländliche periphere Gemeinde")
str_lookup <- data.frame(cbind(original, new))
hh$SettlStruc <- str_lookup$new[match(unlist(hh$SettlStruc), str_lookup$original)]
hh$SettlStruc <- as.factor(hh$SettlStruc)
#----
#Age
names(zielpersonen)[names(zielpersonen) == 'alter'] <- 'Age'
#----
#Regionen
genfersee <- c(25,22,23)
mitelland <- c(2,10,24,26,11)
nordwest <- c(12,13,19)
zurich <- 1
zentralch <- c(3,4,5,6,7,8,9)
ostch <- c(8,14,15,16,17,18,20)
tessin <- 21
hh$Region <- ifelse(hh$W_KANTON==1,"  4.Zürich" ,
ifelse(hh$W_KANTON==21, "  7.Tessin",
ifelse(hh$W_KANTON %in% genfersee, "  1.Genferseeregion",
ifelse(hh$W_KANTON %in% mitelland, "  2.Espace Mittelland",
ifelse(hh$W_KANTON %in% nordwest, "  3.Nordwestschweiz",
ifelse(hh$W_KANTON %in% zentralch, "  6.Zentralschweiz",
ifelse(hh$W_KANTON %in% ostch, "  5.Ostschweiz" ,NA)))))))
hh$Region <- as.factor(hh$Region)
#----
#Education
zielpersonen$Education <- ifelse(zielpersonen$HAUSB %in% c(1,2,3), "  1.Obligatorische Schule",
ifelse(zielpersonen$HAUSB %in% c(4,5,6,7,8,9), "  2.Sekundarstufe II : Berufsbildung",
ifelse(zielpersonen$HAUSB %in% c(11,12), "  3.Sekundarstufe II : allgemein bildende Schulen",
ifelse(zielpersonen$HAUSB %in% c(10,13,14,15,16), "  4.Tertiärstufe: höhere Berufsbildung",
ifelse(zielpersonen$HAUSB %in% c(17,18,19), "  5.Tertiärstufe: Hochschulen",NA)))))
sum((zielpersonen$Education %in% c("-99","-98","-97")))
zielpersonen$Education <- as.factor(zielpersonen$Education)
#-----
#Household structure
hh$HHWithKidsU15 <- ifelse(hh$hhtyp %in% c(220, 230), "  1.Ja", "  2.Nein")
hh$HHWithKidsU15 <- as.factor(hh$HHWithKidsU15)
#-----
#Geschlecht
zielpersonen$Sex <- ifelse(zielpersonen$gesl==1, "  1.Mann", ifelse(zielpersonen$gesl==2, "  2.Frau", zielpersonen$gesl))
zielpersonen[zielpersonen<0 & is.numeric(zielpersonen)] <- NA
zielpersonen$Sex <- as.factor(zielpersonen$Sex)
#----
#Nationality classes
ch <- c(8100,8222)
nordUndWesteuropa <- c(8204,8206,8207,8210,8211,8211,8212,8215,8216,8217,8223,8226,8227,8228,8229,8234)
sudwesteuropa <- c(8213,8218,8224,8231,8236, 8214, 8233, 8241)
sudosteuropaUndOsteuropa <- c(8230,8232,8239,8240,8242,8243,8244,8248,8250,8251,8252,8253,
8254,8255,8256,8257,8260,8261,8262,8263,8264,8265,8266)
zielpersonen$NationCateg <- ifelse(zielpersonen$nation %in% ch,"  1.Schweiz",
ifelse(zielpersonen$nation %in% nordUndWesteuropa, "  2.Nord- und Westeuropa",
ifelse(zielpersonen$nation %in% sudwesteuropa, "  3.Südwesteuropa",
ifelse(zielpersonen$nation %in% sudosteuropaUndOsteuropa, "  4.Ost- und Südosteuropa",
ifelse(zielpersonen$nation<0,NA,"  5.Ausserhalb Europa")))))
zielpersonen$NationCateg <- as.factor(zielpersonen$NationCateg)
WeightHeight <- c("f81501", "f81502")
#----
mzmv <- left_join(hh[,c("HHNR", "SettlStruc", "Region", "HHWithKidsU15")],
zielpersonen[,c("HHNR", "WP", "Age", "NationCateg","Sex", "Education", "BMI")])
#-------------------------------------------------------------------------------------------------------------------------
#_________________________________________________________________________________________________________________________
#Now impute BMI
#___________________________________________________________________________________________________________________________________________
datFinal <- readRDS("C:\\Users\\LMF\\polybox\\BetwAcc_EBikeCity\\DATA\\bagDataFinal.rds")
datFinalBMI <- datFinal[,c("SettlStruc", "Region", "HHWithKidsU15", "Age", "NationCateg","Sex", "Education", "BMI")]
datFinalBMI$HHNR <- -99
datFinalBMI$WP <- -99
datFinalBMI$Sex <- as.factor(datFinalBMI$Sex)
datFinalBMI$Region <- as.factor(datFinalBMI$Region)
datFinalBMI$SettlStruc <- as.factor(datFinalBMI$SettlStruc)
datFinalBMI$HHWithKidsU15 <- as.factor(datFinalBMI$HHWithKidsU15)
datFinalBMI$NationCateg <- as.factor(datFinalBMI$NationCateg)
datFinalBMI$Education <- as.factor(datFinalBMI$Education)
str(datFinalBMI)
mzmv <- left_join(hh[,c("HHNR", "SettlStruc", "Region", "HHWithKidsU15")],
zielpersonen[,c("HHNR", "WP", "Age", "NationCateg","Sex", "Education", "BMI")])
count(mzmv, duplicated(HHNR))
bmi <- mzmv[!is.na(mzmv$BMI), ]
bmi <- na.omit(bmi)
bmi <- rbind(bmi, datFinalBMI)
bmi <- na.omit(bmi)
#We work with normalized BMI so that the BEta distribuitions can be estimated before:
#Generate the normalized BMI values
bmi$BMI <- ifelse(bmi$BMI>70, 70, bmi$BMI)
maxBMI <- max(bmi$BMI)
minBMI <- min(bmi$BMI)
library(tidymodels)
bmi$BMI_norm <- (bmi$BMI-minBMI)/(maxBMI-minBMI)
bmi$BMI5 <- ifelse(bmi$BMI<=18.5,1,
ifelse(bmi$BMI>18.5 & bmi$BMI<=22,2,
ifelse(bmi$BMI>22 & bmi$BMI<=25,3,
ifelse(bmi$BMI>25 & bmi$BMI<=30,4,5))))
bmi$BMI5 <- as.factor(bmi$BMI5)
dt_model_BMI <- nearest_neighbor() %>%
set_mode("regression")
dt_split <- initial_split(bmi, prop=3/4)
training <- training(dt_split)
testing <- testing(dt_split)
library(kknn)
mse_vec <- function(truth, estimate, na_rm = TRUE, ...) {
mse_impl <- function(truth, estimate) {
mean((truth - estimate) ^ 2)
}
metric_vec_template(
metric_impl = mse_impl,
truth = truth,
estimate = estimate,
na_rm = na_rm,
cls = "numeric",
...
)
}
#___________________________________________________________________
modelClass <- dt_model_BMI_class %>% fit(BMI5~NationCateg+log(Age)+Age+I(Age^2)+Education+SettlStruc+Region+
HHWithKidsU15+Sex, data=training)
model <- dt_model_BMI %>% fit(BMI~NationCateg+log(Age)+Age+I(Age^2)+Education+SettlStruc+Region+
HHWithKidsU15+Sex, data=training)
pred <- predict(model, testing)
mse_vec(
truth   = testing$BMI,
estimate = pred$.pred
)
#___________________________________________________________________
model <- dt_model_BMI %>% fit(BMI~NationCateg+log(Age)+Age+I(Age^2)+Education+SettlStruc+Region+
HHWithKidsU15+Sex, data=bmi)
predBMI <-  mzmv[is.na(mzmv$BMI),-which(names(mzmv) %in% c("BMI"))]
predBMI1 <-  na.omit(predBMI)
pred1 <-
predict(modelClass, predBMI1)
BMI5 <- pred1$.pred_class
predBMI1$BMI5 <- BMI5
pred1 <-
predict(model, predBMI1)
pred1 <- cbind(pred1, predBMI1$HHNR)
colnames(pred1) <- c("BMI", "HHNR")
missing <- mzmv[!(mzmv$HHNR %in% pred1$HHNR), ]
missing <- missing[is.na(missing$BMI),]
#Now model without education for missing ones:
model <- dt_model_BMI %>%  fit(BMI~NationCateg+log(Age)+Age+I(Age^2)+Region+
HHWithKidsU15+Sex, data=bmi)
pred2 <-predict(model, missing)
pred2 <- cbind(pred2, missing$HHNR)
colnames(pred2) <- c("BMI", "HHNR")
mz.bmi <- rbind(pred1, pred2)
last <- mzmv[!(mzmv$HHNR %in% mz.bmi$HHNR), c("BMI", "HHNR")]
summary(bmi$BMI)
summary(mz.bmi$BMI)
#Correct the predicted mz.bmi distribuition
#_________________________________________________________________________________________________________
#create aggregation variables:
mz.bmi <- left_join(mz.bmi, mzmv[mzmv$HHNR %in% mz.bmi$HHNR, c("HHNR","Age", "Sex")], by="HHNR")
mz.bmi$ALTER7 <- ifelse(mz.bmi$Age>=75, 7,
ifelse(mz.bmi$Age<75 & mz.bmi$Age>64,6,
ifelse(mz.bmi$Age<64 & mz.bmi$Age>55,5,
ifelse(mz.bmi$Age<55 & mz.bmi$Age>45,4,
ifelse(mz.bmi$Age<45 & mz.bmi$Age>34,3,
ifelse(mz.bmi$Age<34 & mz.bmi$Age>24,2,1))))))
bmi$ALTER7 <- ifelse(bmi$Age>=75, 7,
ifelse(bmi$Age<75 & bmi$Age>64,6,
ifelse(bmi$Age<64 & bmi$Age>55,5,
ifelse(bmi$Age<55 & bmi$Age>45,4,
ifelse(bmi$Age<45 & bmi$Age>34,3,
ifelse(bmi$Age<34 & bmi$Age>24,2,1))))))
mz.bmi$ALTER7 <- as.factor(mz.bmi$ALTER7)
bmi$ALTER7 <- as.factor(bmi$ALTER7)
mz.bmi$BMI5 <- ifelse(mz.bmi$BMI<=18.5,1,
ifelse(mz.bmi$BMI>18.5 & mz.bmi$BMI<=22,2,
ifelse(mz.bmi$BMI>22 & mz.bmi$BMI<=25,3,
ifelse(mz.bmi$BMI>25 & mz.bmi$BMI<=30,4,5))))
bmi$BMI5 <- ifelse(bmi$BMI<=18.5,1,
ifelse(bmi$BMI>18.5 & bmi$BMI<=22,2,
ifelse(bmi$BMI>22 & bmi$BMI<=25,3,
ifelse(bmi$BMI>25 & bmi$BMI<=30,4,5))))
mz.bmi$BMI5 <- as.factor(mz.bmi$BMI5)
bmi$BMI5 <- as.factor(bmi$BMI5)
bmi$BMI <- ifelse(bmi$BMI>70, 70, bmi$BMI)
#_________________________________________________________________________________________________________
ref <- as.data.frame(xtabs(~ALTER7+BMI5+Sex, data=bmi))
ref$dens <- ref$Freq/sum(ref$Freq)
beob <- as.data.frame(xtabs(~ALTER7+BMI5+Sex, data=mz.bmi))
beob$dens <- beob$Freq/sum(beob$Freq)
length <- nrow(as.data.frame(xtabs(~ALTER7+Sex, data=mz.bmi)))
test <- cbind(ref, beob$dens)
test$diff <- test$dens-test$`beob$dens`
# install.packages("fitdistrplus", dependencies = T)
require(fitdistrplus)
#First fit correct distribuitions for each row of the reference observations:
#Fit distribuition
# options(warn = 0)
str(beob)
row=0
library(data.table)
for (i in levels(beob$ALTER7)){
for(o in levels(beob$Sex)){
print(paste(round(100*row/length,1), "% complete", sep=""))
row=row+1
bb <- beob[beob$ALTER7==i & beob$Sex==o, ]
rr <- ref[ref$ALTER7==i & ref$Sex==o, ]
bb$dens <- bb$Freq/sum(bb$Freq)
rr$dens <- rr$Freq/sum(rr$Freq)
bb$diff <- bb$dens-rr$dens
bb$BMI5 <- as.numeric(bb$BMI5)
rr$BMI5 <- as.numeric(rr$BMI5)
finish=20
#Run it three times to ensure enough changes are made
while(finish!=0){
finish = finish-1
for(j in max(bb$BMI):1){
#Get difference of present group:
thisDiff <- bb[bb$BMI5==j & bb$ALTER7==i & bb$Sex==o,]$diff
bb$Donors <- 0
if(length(thisDiff)!=0){
if(thisDiff<0.02){
goal <- floor(abs(thisDiff)*sum(bb$Freq))
number <- 0
diff <- goal
k=j
switch=0
while(diff>0){
# print(k)
if(k != j){
if(length(bb[bb$BMI==k,]$Freq)!=0) {
bb[bb$BMI5==k,]$Donors <- ifelse(bb[bb$BMI5==k,]$Freq>0 & bb[bb$BMI5==k,]$Freq<=diff,
bb[bb$BMI5==k,]$Freq,
ifelse(bb[bb$BMI5==k,]$Freq>0 & bb[bb$BMI5==k,]$Freq>=goal,diff,0))
number <- number + bb[bb$BMI5==k,]$Donors
diff <- goal-number
}
}
#Search in other direction if nothing is found
if(k==min(bb$BMI5) & goal>0){
k=j
switch=1
}
if(switch==0){
k=k-1
} else if(switch==1){
k=k+1
}
}
#Now randomly assign the donors to the new class and distribute the values with an uniform distribuition:
donors <- bb[bb$Donors>0, ]
for (t in unique(donors$BMI5)){
amount <- donors[donors$BMI5==t, ]$Donors
#Now distribute values to the donors according to distribuition of the observed data
thiData <- bmi[bmi$ALTER7 == i & bmi$BMI5 == j & bmi$Sex == o, ]$BMI
lognormal <- fitdistrplus::fitdist(thiData, "lnorm")
values <- rlnorm(amount, meanlog=getElement(lognormal$estimate,"meanlog"), sdlog=getElement(lognormal$estimate,"sdlog"))
#Assign the donors to new BMI5 category
selection <-  mz.bmi[mz.bmi$Sex==o & mz.bmi$ALTER7==i & mz.bmi$BMI5 == t,]
selection <- selection[sample(1:nrow(selection),amount), ]
selection$BMI5 <- j
selection$BMI <- values
mz.bmi <- mz.bmi[!(mz.bmi$HHNR %in% selection$HHNR), ]
mz.bmi <- as.data.table(mz.bmi)
selection <- as.data.table(selection)
bind <- list(mz.bmi, selection)
mz.bmi <- rbindlist(bind)
mz.bmi <- as.data.frame(mz.bmi)
#now delete changed data from mz.bmi and add new one:
#Recalculate matrices from mz.bmi
beob <- as.data.frame(xtabs(~ALTER7+BMI5+Sex, data=mz.bmi))
bb <- beob[beob$ALTER7==i & beob$Sex==o, ]
bb <- beob[beob$ALTER7==i & beob$Sex==o, ]
rr <- ref[ref$ALTER7==i & ref$Sex==o, ]
bb$dens <- bb$Freq/sum(bb$Freq)
rr$dens <- rr$Freq/sum(rr$Freq)
bb$diff <- bb$dens-rr$dens
bb$BMI5 <- as.numeric(bb$BMI5)
rr$BMI5 <- as.numeric(rr$BMI5)
}
}
}
}
}
}
}
#_________________________________________________________________________________________________________
colnames(mz.bmi) <- c("BMI", "HHNR")
mz.bmi <- mz.bmi[,1:2]
mz.bmi <- rbind(mz.bmi, last)
library(fitdistrplus)
fitdistrplus::descdist(mz.bmi$BMI)
fitdistrplus::descdist(bmi$BMI)
count(mz.bmi, BMI5)
count(bmi, BMI5)
hist(bmi$BMI, 50)
hist(mz.bmi$BMI, 50)
#____________________________________________________________________________________________
#Attach bmi to Zielpersonen
mzmv$BMI <- NULL
mzmv <- left_join(mzmv, mz.bmi)
count(mzmv, duplicated(HHNR))
#NOW ADD PASS ACTIVITY SCALE!!!
#___________________________________________________________________________________________
library(tidymodels)
training <- readRDS("C:\\Users\\LMF\\polybox\\BetwAcc_EBikeCity\\data\\trainingDataPASS_BAG.rds")
str(training)
dt_split <- initial_split(training, prop=3/4)
train <- training(dt_split)
test <- testing(dt_split)
dt_model <- nearest_neighbor(neighbors = 80, weight_func = "gaussian") %>% set_mode("classification")
# dt_model <- rand_forest(trees = 800, mtry=2, min_n = 200) %>% set_mode("classification")
model <- dt_model %>%  fit(PASS~log(Age)+Age+I(Age^2)+NationCateg+Region+SettlStruc+
Sex+BMI,
data =train)
pred <- predict(model, test)
sqrt(mse_vec(truth=as.numeric(test$PASS), estimate=as.numeric(pred$.pred_class)))
model <- dt_model %>%  fit(PASS~log(Age)+Age+I(Age^2)+NationCateg+Region+
Sex+BMI,
data =training)
pred <- predict(model, mzmv)
mzmv$PASS <- pred$.pred_class
#Now correct the estimations:
training$BMI5 <- ifelse(training$BMI<=18.5,1,
ifelse(training$BMI>18.5 & training$BMI<=22,2,
ifelse(training$BMI>22 & training$BMI<=25,3,
ifelse(training$BMI>25 & training$BMI<=30,4,5))))
training$BMI5 <- as.factor(training$BMI5)
mzmv$BMI5 <- ifelse(mzmv$BMI<=18.5,1,
ifelse(mzmv$BMI>18.5 & mzmv$BMI<=22,2,
ifelse(mzmv$BMI>22 & mzmv$BMI<=25,3,
ifelse(mzmv$BMI>25 & mzmv$BMI<=30,4,5))))
mzmv$BMI5 <- as.factor(mzmv$BMI5)
training$BMI5 <- ifelse(training$BMI<=18.5,1,
ifelse(training$BMI>18.5 & training$BMI<=22,2,
ifelse(training$BMI>22 & training$BMI<=25,3,
ifelse(training$BMI>25 & training$BMI<=30,4,5))))
training$BMI5 <- as.factor(training$BMI5)
mzmv$ALTER7 <- ifelse(mzmv$Age>=75, 7,
ifelse(mzmv$Age<75 & mzmv$Age>64,6,
ifelse(mzmv$Age<64 & mzmv$Age>55,5,
ifelse(mzmv$Age<55 & mzmv$Age>45,4,
ifelse(mzmv$Age<45 & mzmv$Age>34,3,
ifelse(mzmv$Age<34 & mzmv$Age>24,2,1))))))
mzmv$ALTER7 <- as.factor(mzmv$ALTER7)
mzmv$ALTER7 <- factor(mzmv$ALTER7, ordered = T, levels = levels(mzmv$ALTER7))
grouped <- training %>% group_by(ALTER7, Sex, BMI5, PASS) %>% dplyr::summarise(n=n())
grouped_n <- training %>% group_by(ALTER7, Sex, BMI5) %>% dplyr::summarise(n=n())
for (i in 1:nrow(grouped_n)){
print(i)
this <- grouped_n[i,1:3]
percReq <- grouped[grouped$ALTER7==this$ALTER7 & grouped$Sex==this$Sex & grouped$BMI5 == this$BMI5, ]
#Check PASS distribution in mzmv
mz <- mzmv[mzmv$Sex==this$Sex & mzmv$ALTER7==this$ALTER7 & mzmv$BMI5 == this$BMI5,]
MZgrouped <- mz %>% group_by(ALTER7, Sex, BMI5, PASS) %>% dplyr::summarise(n=n())
MZgrouped$percMZ <- MZgrouped$n/sum(MZgrouped$n)
percReq$ALTER7 <- as.numeric(percReq$ALTER7)
MZgrouped$ALTER7 <- as.numeric(MZgrouped$ALTER7)
percReq$PASS <- as.numeric(as.character(percReq$PASS))
MZgrouped$PASS <- as.numeric(as.character(MZgrouped$PASS))
percReq <- left_join(percReq, MZgrouped, by=c("ALTER7", "Sex", "BMI5", "PASS"))
percReq[is.na(percReq)] <- 0
percReq$Perc <- percReq$n.x/sum(percReq$n.x)
percReq$diff <- percReq$percMZ-percReq$Perc
finish=20
#Run it three times to ensure enough changes are made
while(finish!=0){
finish = finish-1
for(j in 10:1){
print(j)
percReq$Donors <- 0
thisDiff <- percReq[percReq$PASS==j,]$diff
if(length(thisDiff)!=0){
if(thisDiff<0.02){
goal <- floor(abs(thisDiff)*sum(percReq$n.y))
number <- 0
diff <- goal
k=j
switch=0
while(diff>0){
if(k != j){
if(length(percReq[percReq$PASS==k,]$n.y)!=0) {
percReq[percReq$PASS==k,]$Donors <- ifelse(percReq[percReq$PASS==k,]$n.y>0 & percReq[percReq$PASS==k,]$n.y<=diff,
percReq[percReq$PASS==k,]$n.y,
ifelse(percReq[percReq$PASS==k,]$n.y>0 & percReq[percReq$PASS==k,]$n.y>=goal,diff,0))
number <- number + percReq[percReq$PASS==k,]$Donors
diff <- goal-number
}
}
#Search in other direction if nothing is found
if(k==min(percReq$PASS) & goal>0){
k=j
switch=1
number <- 0
}
if(switch==0){
k=k-1
} else if(switch==1){
k=k+1
}
#With too little observations the loop never ends:
if(k>15){
diff=0
}
}
#Now randomly assign the donors to the new class:
donors <- percReq[percReq$Donors>0, ]
for (o in unique(donors$PASS)){
amount <- donors[donors$PASS==o, ]$Donors
#Assign the donors to new values
# mzmv[mzmv$Sex==this$Sex & mzmv$ALTER7==this$ALTER7 & mzmv$BMI5 == this$BMI5 & mzmv$PASS == o,][sample(nrow(mzmv[mzmv$Sex==this$Sex & mzmv$ALTER7==this$ALTER7 & mzmv$BMI5 == this$BMI5 & mzmv$PASS == o,]),amount), ]$PASS <- j
selection <-  mzmv[mzmv$Sex==this$Sex & mzmv$ALTER7==this$ALTER7 & mzmv$BMI5 == this$BMI5 & mzmv$PASS == o,]
selection <- selection[sample(1:nrow(selection),amount), ]
selection$PASS <- j
mzmv <- mzmv[!(mzmv$HHNR %in% selection$HHNR), ]
mzmv <- as.data.table(mzmv)
selection <- as.data.table(selection)
bind <- list(mzmv, selection)
mzmv <- rbindlist(bind)
mzmv <- as.data.frame(mzmv)
#Recalculate matrices
percReq <- grouped[grouped$ALTER7==this$ALTER7 & grouped$Sex==this$Sex & grouped$BMI5 == this$BMI5, ]
#Check PASS distribution in mzmv
mz <- mzmv[mzmv$Sex==this$Sex & mzmv$ALTER7==this$ALTER7 & mzmv$BMI5 == this$BMI5,]
MZgrouped <- mz %>% group_by(ALTER7, Sex, BMI5, PASS) %>% dplyr::summarise(n=n())
MZgrouped$percMZ <- MZgrouped$n/sum(MZgrouped$n)
percReq$ALTER7 <- as.numeric(percReq$ALTER7)
MZgrouped$ALTER7 <- as.numeric(MZgrouped$ALTER7)
percReq$PASS <- as.numeric(as.character(percReq$PASS))
MZgrouped$PASS <- as.numeric(as.character(MZgrouped$PASS))
percReq <- left_join(percReq, MZgrouped, by=c("ALTER7", "Sex", "BMI5", "PASS"))
percReq[is.na(percReq)] <- 0
percReq$Perc <- percReq$n.x/sum(percReq$n.x)
percReq$diff <- percReq$percMZ-percReq$Perc
}
#Now the same for the case of a positive difference (here we look from the bottom up)
}
}
}
}
}
hist(as.numeric(training$PASS))
hist(as.numeric(mzmv$PASS))
saveRDS(mzmv)
hist(as.numeric(training$PASS))
hist(as.numeric(mzmv$PASS))
count(mzmv, duplicated(HHNR))
saveRDS(mzmv, "C:\\Users\\LMF\\polybox\\BetwAcc_EBikeCity\\DATA\\mzmvEnrichedWithPASS_220415.rds")
devtools::document()
usethis::use_package("plotKML")
usethis::use_package("sp")
devtools::document()
